<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>EDM工具</title>
	<link rel="stylesheet" href="../lib/codemirror.css">
	<link rel="stylesheet" href="../addon/fold/foldgutter.css">
	<link rel="stylesheet" href="../addon/dialog/dialog.css">
	<link rel="stylesheet" href="../theme/monokai.css">
	<script src="../lib/codemirror.js"></script>
	<script src="../addon/search/searchcursor.js"></script>
	<script src="../addon/search/search.js"></script>
	<script src="../addon/dialog/dialog.js"></script>
	<script src="../addon/edit/matchbrackets.js"></script>
	<script src="../addon/edit/closebrackets.js"></script>
	<script src="../addon/comment/comment.js"></script>
	<script src="../addon/wrap/hardwrap.js"></script>
	<script src="../addon/fold/foldcode.js"></script>
	<script src="../addon/fold/brace-fold.js"></script>
	<script src="../mode/javascript/javascript.js"></script>
	<script src="../keymap/sublime.js"></script>

	<!--  -->
	<link rel="stylesheet" href="../lib/codemirror.css">
	<link rel="stylesheet" href="../addon/hint/show-hint.css">
	<script src="../lib/codemirror.js"></script>
	<script src="../addon/hint/show-hint.js"></script>
	<script src="../addon/hint/xml-hint.js"></script>
	<script src="../mode/xml/xml.js"></script>
	<!--  -->

	<style type="text/css">
	.CodeMirror {
		border-top: 1px solid #eee; 
		border-bottom: 1px solid #eee; 
		line-height: 1.3; 
		height: 800px;
	}
	.CodeMirror-linenumbers { 
		padding: 0 8px; 
	}
	</style>
</head>
<body>
	<article>
	<form>
	<textarea id="code" name="code"><!-- write some xml below -->
	</textarea>
	</form>

	<script>
	  var value = "";
	  // var map = CodeMirror.keyMap.sublime;
	  // for (var key in map) {
	  //   var val = map[key];
	  //   if (key != "fallthrough" && val != "..." && (!/find/.test(val) || /findUnder/.test(val)))
	  //     value += "  \"" + key + "\": \"" + val + "\",\n";
	  // }
	  // value += "}\n\n// The implementation of joinLines\n";
	  // value += CodeMirror.commands.joinLines.toString().replace(/^function\s*\(/, "function joinLines(").replace(/\n  /g, "\n") + "\n";

	  // var editor = CodeMirror(document.body.getElementsByTagName("article")[0], {
	 //    value: value,
	 //    lineNumbers: true,
	 //    mode: "javascript",
	 //    keyMap: "sublime",
	 //    autoCloseBrackets: true,
	 //    matchBrackets: true,
	 //    showCursorWhenSelecting: true,
	 //    theme: "monokai"
	 //  });
	 //  
	

	var dummy = {
        attrs: {
          color: ["red", "green", "blue", "purple", "white", "black", "yellow"],
          size: ["large", "medium", "small"],
          description: null
        },
        children: []
      };

    var tags = {
        "!top": ["top"],
        "!attrs": {
          id: null,
          class: ["A", "B", "C"]
        },
        top: {
          attrs: {
            lang: ["en", "de", "fr", "nl"],
            freeform: null
          },
          children: ["animal", "plant"]
        },
        animal: {
          attrs: {
            name: null,
            isduck: ["yes", "no"]
          },
          children: ["wings", "feet", "body", "head", "tail"]
        },
        plant: {
          attrs: {name: null},
          children: ["leaves", "stem", "flowers"]
        },
        wings: dummy, feet: dummy, body: dummy, head: dummy, tail: dummy,
        leaves: dummy, stem: dummy, flowers: dummy
      };

      function completeAfter(cm, pred) {
        var cur = cm.getCursor();
        if (!pred || pred()) setTimeout(function() {
          if (!cm.state.completionActive)
            cm.showHint({completeSingle: false});
        }, 100);
        return CodeMirror.Pass;
      }

      function completeIfAfterLt(cm) {
        return completeAfter(cm, function() {
          var cur = cm.getCursor();
          return cm.getRange(CodeMirror.Pos(cur.line, cur.ch - 1), cur) == "<";
        });
      }

      function completeIfInTag(cm) {
        return completeAfter(cm, function() {
          var tok = cm.getTokenAt(cm.getCursor());
          if (tok.type == "string" && (!/['"]/.test(tok.string.charAt(tok.string.length - 1)) || tok.string.length == 1)) return false;
          var inner = CodeMirror.innerMode(cm.getMode(), tok.state).state;
          return inner.tagName;
        });
      }

      var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        mode: "xml",
        lineNumbers: true,
        extraKeys: {
          "'<'": completeAfter,
          "'/'": completeIfAfterLt,
          "' '": completeIfInTag,
          "'='": completeIfInTag,
          "Ctrl-Space": "autocomplete"
        },
        hintOptions: {schemaInfo: tags}
      });
	</script>
	</article>
</body>
</html>